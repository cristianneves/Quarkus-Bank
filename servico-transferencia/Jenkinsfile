pipeline {
    agent any
    tools { maven 'maven' }

    environment {
        SONAR_TOKEN = credentials('sonar-token')
        // 游 Desativamos a orquestra칞칚o autom치tica que est치 travando
        QUARKUS_DEVSERVICES_ENABLED = 'false'
        DB_URL = 'jdbc:postgresql://172.17.0.1:5432/transacoes' // IP padr칚o do Gateway Docker
    }

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        // 游 NOVO EST츼GIO: Garantir o Banco de Dados de p칠
        stage('Prepare DB') {
            steps {
                script {
                    // Remove qualquer container antigo para n칚o dar conflito de nome
                    sh "docker rm -f pg-test || true"
                    // Sobe o Postgres manualmente
                    sh "docker run -d --name pg-test -e POSTGRES_USER=quarkus -e POSTGRES_PASSWORD=quarkus -e POSTGRES_DB=transacoes -p 5432:5432 postgres:17"
                    // Aguarda 10 segundos para o banco respirar
                    sleep 10
                }
            }
        }

        stage('Compila칞칚o e Testes') {
            steps {
                dir('servico-transferencia') {
                    // 游 Passamos as credenciais do banco manual diretamente para o Quarkus
                    sh """
                    mvn clean verify \
                    -Dquarkus.datasource.jdbc.url=${env.DB_URL} \
                    -Dquarkus.datasource.username=quarkus \
                    -Dquarkus.datasource.password=quarkus
                    -Dquarkus.hibernate-orm.database.generation=drop-and-create \
                    -Dquarkus.kafka.devservices.enabled=false \
                    -Dkafka.bootstrap.servers=172.17.0.1:9092
                    """
                }
            }
        }

        stage('An치lise SonarQube') {
            steps {
                dir('servico-transferencia') {
                    script {
                        withSonarQubeEnv('SonarQubeServer') {
                            sh "mvn sonar:sonar -Dsonar.projectKey=bb-transferencias"
                        }
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    // Aborta se a cobertura for baixa ou houver bugs cr칤ticos
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        // 5. Build do Artefato Final (S칩 chega aqui se a qualidade for 100%)
        stage('Build do Pacote (JAR)') {
            steps {
                dir('servico-transferencia') {
                    sh 'mvn package -DskipTests'
                }
            }
        }

        // 6. Cria칞칚o da Imagem Docker
        stage('Build Docker Image') {
            steps {
                dir('servico-transferencia') {
                    sh "docker build -f src/main/docker/Dockerfile.jvm -t bb/servico-transferencia:${env.BRANCH_NAME} ."
                }
            }
        }
    }

    post {
        always {
            // 游 Limpeza: N칚o deixa lixo no Docker do seu Windows
            sh "docker rm -f pg-test || true"
        }
    }
}